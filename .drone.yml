branches: [ dev, qa, master ]
pipeline:
  install:
    image: node:8.1.2
    commands:
      - npm install --global yarn
      - yarn install
  check-git-logs:
    image: plugins/git
    commands:
      - git log -5 > git-logs.txt
      - cat git-logs.txt
      - rm git-logs.txt
  print-drone-vars:
    image: node:8.1.2
    commands:
      - yarn drone-vars
  fetch-latest-code:
    image: plugins/git
    commands:
      - git fetch origin
  expose-env-var:
    image: plugins/git
    commands:
      - export REPO=someVal
      - echo $REPO
  read-env-var:
    image: plugins/git
    commands:
      - echo $REPO
      - echo {{ repo.owner }} {{ repo.name }}
  unit-test:
    image: node:8.1.2
    commands:
      - yarn test
  prepare-integration-test:
    image: plugins/git
    commands:
      - git config --global user.email "drone-bot@moengage.com"
      - git config --global user.name "Drone CI"
      - git branch -D merged_state || true
      - git fetch origin pull/$CI_PULL_REQUEST/head:merged_state
      - git fetch origin $DRONE_BRANCH
      - git checkout $DRONE_BRANCH
      - git pull origin $DRONE_BRANCH
      - git merge --no-ff merged_state
      - git log -2
  start-integration-test:
    image: node:8.1.2
    commands:
      - yarn test
  check-dev-file:
    image: node:8.1.2
    commands:
      - cat dev-only_file